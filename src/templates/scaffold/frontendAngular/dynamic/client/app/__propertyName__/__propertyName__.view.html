<%
    allProps = scaffoldingHelper.getProps(domainClass)
    props = allProps.grep{it.cp?.display != false}
   
%>
<%
private String renderFieldRow(p, owningClass, parentProperty = null){

    if(p.cp.widget == 'autocomplete' || parentProperty?.cp?.widget == 'autocomplete'){
        return renderAutocomplete(domainClass, p, parentProperty)
    }else if (p.type == Boolean || p.type == boolean)
        return renderBoolean(owningClass, p, parentProperty)
    else if (p.type && Number.isAssignableFrom(p.type) || (p.type?.isPrimitive() && p.type != boolean))
        return renderString(owningClass, p, parentProperty)
    else if (p.type == String)
        return renderString(owningClass, p, parentProperty)
    else if (p.type == Date || p.type == java.sql.Date || p.type == java.sql.Time || p.type == Calendar)
        return renderDate(owningClass, p, parentProperty)
    else if (p.type == URL)
        return renderString(owningClass, p, parentProperty)
    else if (p.type && p.isEnum())
        return renderEnum(owningClass, p, parentProperty)
    else if (p.type == TimeZone)
        return renderSelectType(owningClass, p, parentProperty, "timeZone")
    else if (p.type == Locale)
        return renderSelectType(owningClass, p, parentProperty, "locale")
    else if (p.type == Currency)
        return renderSelectType(owningClass, p, parentProperty, "currency")
    else if (p.type==([] as byte[]).class) //TODO: Bug in groovy means i have to do this :(
        return renderByteArray(owningClass, p, parentProperty)
    else if (p.manyToOne || p.oneToOne)
        return renderManyToOne(owningClass, p, parentProperty)
    else if (p.joinProperty){
        return renderJoinProperty(domainClass, p, parentProperty, p.joinProperty)
    }else if ((p.oneToMany && !p.bidirectional) || p.manyToMany) {
        return renderManyToMany(domainClass, p, parentProperty)
    }else if (p.oneToMany)
        return renderOneToMany(domainClass, p, parentProperty)
    else if (p.type == java.util.Map)
        return renderMap(domainClass, p, parentProperty)
    else
        return "<!-- No type for ${p.name} type ${p.type}-->"

}


private String renderString(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    return """
        <div class="form-group">
            <label class="col-sm-2 control-label"
                   translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static"
                 ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private String renderDate(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    return """
    <div class="form-group">
        <label class="col-sm-2 control-label"
               translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
        <div class="col-sm-10 form-control-static"
             ng-bind="${owningClass.propertyName}.${parentPropName}${p.name} | date:'yyyy-MM-dd HH:mm'"></div>
    </div>
    <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private String renderBoolean(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
   return """
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static" ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private String renderByteArray(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
   return """
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static" ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}


private renderSelectType(owningClass, p, parentProperty, type) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
     return """
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static" ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private String renderEnum(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
     return """
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static" ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private String renderManyToOne(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    Map useDisplaynames = scaffoldingHelper.getDomainClassDisplayNames(owningClass, p)
    if(!useDisplaynames) useDisplaynames = ["id":null]
    
    String str = """<!--ManyToOne-->
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static">
            """
    useDisplaynames.each{ key, value->
        str += """<span ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}.${key}"></span> """
    }
    str += """</div></div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
    
    return str
}

private String renderManyToMany(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    Map useDisplaynames = scaffoldingHelper.getDomainClassDisplayNames(owningClass, p)
    if(!useDisplaynames) useDisplaynames = ["id":null]

    String str = """<!--ManyToMany-->
    <div class="form-group">
        <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
        <div class="col-sm-10 form-control-static">
            <div ng-repeat="item in ${owningClass.propertyName}.${parentPropName}${p.name}">
"""
    useDisplaynames.each{ key, value->
    str += """<span ng-bind="item.${key}"></span> """
    }
    str += """</div></div></div>
    <div class="line line-dashed b-b line-lg pull-in"></div>
    """

    return str
}

private String renderOneToMany(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    return """<!--OneToMany-->
        <div class="form-group">
            <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
            <div class="col-sm-10 form-control-static" ng-bind="${owningClass.propertyName}.${parentPropName}${p.name}"></div>
        </div>
        <div class="line line-dashed b-b line-lg pull-in"></div>
    """
}

private renderJoinProperty(owningClass, p, parentProperty, joinProperty) {
    return  """//JoinProperty
    //${grails.util.GrailsNameUtils.getShortName(p.getReferencedPropertyType()).toLowerCase()}
                //${grails.util.GrailsNameUtils.getShortName(joinProperty.getReferencedPropertyType()).toLowerCase()}
                //referencedPropertyName:'${p.getReferencedPropertyName()}.id'
                //${p.naturalName}
        """
}


private String renderMap(owningClass, p, parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''

    String str = """<!--Map-->
    <div class="form-group">
        <label class="col-sm-2 control-label" translate="pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"></label>
        <div class="jsonView jsonRead col-sm-10 form-control-static">
            <json child="${domainClass.propertyName}.${parentPropName}${p.name}" default-collapsed="false" type="object"></json>
        </div>
    </div>
    <div class="line line-dashed b-b line-lg pull-in"></div>
    """

    return str
}
private String renderAutocomplete(owningClass, p,  parentProperty) {
    String parentPropName = (parentProperty?.component) ? parentProperty.name + '.' : ''
    String acFunctionName = (p.cp.format)?:p.name

    boolean displayParentPropName = false
    if(parentProperty){
        def embeddedProps = scaffoldingHelper.getProps(parentProperty.component).grep{it.cp?.display != false &&it.cp?.editable != false && it.name!= 'id'}
        displayParentPropName =(embeddedProps.size()==1)

        acFunctionName = (parentProperty?.cp?.format)?:parentProperty.name
    }

    String translateStr = "pages.${owningClass.shortName}.view.field.${parentPropName}${p.name}"
    if(displayParentPropName)translateStr = "pages.${domainClass.shortName}.view.field.${parentProperty.name}.title"

    return """<!--Autocomplete-->
    <div class="form-group">
        <label class="col-sm-2 control-label" translate="${translateStr}"></label>
        <div class="col-sm-10 form-control-static"
             ng-bind="autocompleteService.${acFunctionName}SimpleFormatLabel(${owningClass.propertyName}.${parentPropName}${p.name})"></div>
    </div>
    <div class="line line-dashed b-b line-lg pull-in"></div>
"""
}
%>
<div id="${domainClass.propertyName}_view" ng-init="pageTitle = 'pages.${domainClass.shortName}.view.title'"
     ng-include=" 'shared/blocks/page_heading.html' "></div>
<div class="wrapper-md bg-white-only ng-scope">
    <div class="form-horizontal">
<%for (p in props) {
        if(p.embedded){
            def embeddedProps = scaffoldingHelper.getProps(p.component).grep{it.cp?.display != false && it.name!= 'id'}
            if(embeddedProps){
                if(embeddedProps.size()==1 || p.cp.widget == 'autocomplete'){
                    println renderFieldRow(embeddedProps.first(), domainClass, p)
                }else{
                    %>
                <accordion close-others="false" id="${p.name}Accordion">
                    <accordion-group
                            heading="{{'pages.${domainClass.shortName}.view.field.${p.name}.title' | translate}}"
                            is-open="isSearchOpen">
                        <div class="row">
                            <%embeddedProps.each{ep->
                            println renderFieldRow(ep, domainClass, p)
                            }%>
                        </div>
                    </accordion-group>
                </accordion>
                    <%
                }
            }
        }else{
            println renderFieldRow(p, domainClass)
        }
}%>
    </div>
    <div class="line line-dashed b-b line-lg pull-in"></div>
    <div class="form-group">
        <div class="form-action pull-right">
            <a id="editBtn" class="btn btn-default"
               ui-sref="app.${domainClass.propertyName}.edit({id:${domainClass.propertyName}.id})">
                <i class="fa fa-edit" translate="pages.${domainClass.shortName}.view.edit"></i>
            </a>
            <a id="deleteBtn" class="btn btn-danger"
               ng-click="delete${domainClass.shortName}(${domainClass.propertyName})" mx-show-loading>
                <i class="fa fa-trash-o" translate="pages.${domainClass.shortName}.view.delete"></i>
            </a>

            <a id="backBtn" class="btn btn-default" ng-click="back()">
                <i class="fa fa-chevron-left" translate="pages.${domainClass.shortName}.view.back"></i>
            </a>
        </div>
        <div class="clearfix"/>
    </div>
</div>
<div>
    <tabset>


<%
relationsProps = scaffoldingHelper.findRelationsProps(domainClass, domainClasses as List)
relationsProps.each{property, domainCl->
    Map useDisplaynames = scaffoldingHelper.getDomainClassDisplayNames(domainCl, property)
    if(!useDisplaynames) useDisplaynames = ['id': null]
    String useDisplaynamesStr = useDisplaynames.collect{key, value->"'" + key + "'"}.join(",")
%>
        <tab ui-sref="app.${domainClass.propertyName}.view.${domainCl.propertyName}({relationName:'${property.name}s'})"
             ui-sref-active="active">
            <tab-heading
                   translate="pages.${domainCl.shortName}.view.lists"
                   translate-value-isval="{{ 'pages.${property.getDomainClass().shortName}.view.field.${property.name}' | translate }}"
                   translate-value-inval="{{ 'pages.${domainCl.shortName}.name' | translate }}">
            </tab-heading>
        </tab>
<%}%>
    </tabset>
    <div ui-view ><div class="wrapper-md bg-white-only ng-scope">{{'pages.${domainClass.shortName}.view.selecttab' |
        translate}}</div></div>
</div>
